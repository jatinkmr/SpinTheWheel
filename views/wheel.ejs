const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const spinBtn = document.getElementById('spinBtn');
const resultDiv = document.getElementById('result');

const prizes = ['10 Points', '50 Points', '100 Points', 'Try Again', 'Free Spin', '500 Points'];
const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD', '#D4A5A5'];
let startAngle = 0;
let isSpinning = false;

function drawWheel() {
    const arc = Math.PI / (prizes.length / 2);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    for (let i = 0; i < prizes.length; i++) {
        const angle = startAngle + i * arc;
        ctx.fillStyle = colors[i];
        ctx.beginPath();
        ctx.arc(200, 200, 180, angle, angle + arc);
        ctx.lineTo(200, 200);
        ctx.fill();
        
        ctx.save();
        ctx.fillStyle = '#fff';
        ctx.font = '16px Arial';
        ctx.translate(
            200 + Math.cos(angle + arc / 2) * 140,
            200 + Math.sin(angle + arc / 2) * 140
        );
        ctx.rotate(angle + arc / 2 + Math.PI / 2);
        ctx.fillText(prizes[i], -ctx.measureText(prizes[i]).width / 2, 0);
        ctx.restore();
    }
    
    // Draw arrow
    ctx.fillStyle = '#333';
    ctx.beginPath();
    ctx.moveTo(200, 20);
    ctx.lineTo(180, 60);
    ctx.lineTo(220, 60);
    ctx.closePath();
    ctx.fill();
}

function getPrizeIndex(finalAngle) {
    const arc = 360 / prizes.length; // Each segment is 60 degrees (360/6)
    // Convert finalAngle from radians to degrees and normalize to 0-360
    let normalizedAngle = ((finalAngle * 180 / Math.PI) % 360 + 360) % 360;
    // Adjust for arrow at top (0 degrees) and clockwise rotation
    // Add 90 degrees to align with the first prize segment at the top
    normalizedAngle = (normalizedAngle + 90) % 360;
    // Calculate index (0 to 5), reversing to match prize order
    let index = Math.floor(normalizedAngle / arc);
    index = (prizes.length - index) % prizes.length;
    // Ensure index is within bounds
    return (index + prizes.length) % prizes.length;
}

function spinWheel() {
    if (isSpinning) return;
    isSpinning = true;
    spinBtn.disabled = true;
    
    const spinTime = Math.random() * 3000 + 2000; // 2-5 seconds
    const spinAngle = Math.random() * 360 + 720; // At least two full rotations
    let currentTime = 0;
    
    function animate() {
        currentTime += 16; // Approx 60fps
        const progress = currentTime / spinTime;
        const easeOut = 1 - Math.pow(1 - progress, 3); // Cubic ease-out
        startAngle = (spinAngle * easeOut) * Math.PI / 180;
        
        drawWheel();
        
        if (currentTime < spinTime) {
            requestAnimationFrame(animate);
        } else {
            isSpinning = false;
            spinBtn.disabled = false;
            const prizeIndex = getPrizeIndex(startAngle);
            resultDiv.innerHTML = `<p>You won: ${prizes[prizeIndex]}</p>`;
        }
    }
    
    requestAnimationFrame(animate);
}

drawWheel();
spinBtn.addEventListener('click', spinWheel);